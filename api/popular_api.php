<?phpinclude_once("../includes/connection.php"); switch ($_SERVER['REQUEST_METHOD']) {    case 'GET':	    if(isset($_GET['criteria']))		{		    $criteria=$_GET['criteria'];			if ($criteria=="book")			{		       //get the 50 most popular books		       $res = mysql_query(sprintf("SELECT * FROM Book order by popularity desc LIMIT 50"))or die(mysql_error());			   while ($row = mysql_fetch_assoc($res))			     	{			           if ($row['cover_path']==NULL)			           $b=array('type'=>0,'image'=>0);			           else			            {			              $b_id=$row['b_id'];				          $filename='../epubs/'.$b_id.'/'.$row['cover_path'];						  $path=pathinfo('../epubs/'.$b_id.'/'.$row['cover_path']);						  $filetype=$path['extension'];						  list($width, $height, $type, $attr) = getimagesize($filename);						  if ($height>201)						  {								 require_once("SimpleImage.php");								 $img = new SimpleImage();								 $img->load($filename);								 $img->resizeToHeight(200);								 $img->save($filename);						  }						  if ($filename) 						  {							 $imgbinary = fread(fopen($filename, "r"), filesize($filename));							 $base64 = chunk_split(base64_encode($imgbinary));                              $b=array('type'=>$filetype,'image'=>$base64);			                }			             }		                 header('Content-Type:application/json');			    	     $row=array_merge($b,$row);			    		 $array2[] = $row;			     	}			    	if (isset($array2))		            header('Content-Type:application/json');                    echo json_encode($array2);			}			else if ($criteria=="newest")			{		       //get the 50 most popular books		       $res = mysql_query(sprintf("SELECT * FROM Book order by uploaded_time desc LIMIT 50"))or die(mysql_error());			   while ($row = mysql_fetch_assoc($res))			     	{			           if ($row['cover_path']==NULL)			           $b=array('type'=>0,'image'=>0);			           else			            {			               $b_id=$row['b_id'];				           $filename='../epubs/'.$b_id.'/'.$row['cover_path'];							  $path=pathinfo('../epubs/'.$b_id.'/'.$row['cover_path']);							  $filetype=$path['extension'];							  list($width, $height, $type, $attr) = getimagesize($filename);							  if ($height>201)							  {									 require_once("SimpleImage.php");									 $img = new SimpleImage();									 $img->load($filename);									 $img->resizeToHeight(200);									 $img->save($filename);							  }							  if ($filename) 							  {								 $imgbinary = fread(fopen($filename, "r"), filesize($filename));								 $base64 = chunk_split(base64_encode($imgbinary));                              $b=array('type'=>$filetype,'image'=>$base64);			                }			             }		                 header('Content-Type:application/json');			    	     $row=array_merge($b,$row);			    		 $array2[] = $row;			     	}			    	if (isset($array2))		            header('Content-Type:application/json');                    echo json_encode($array2);			}			else if($criteria="page")			{			   $paging=$_GET['p_id'];			   $bookNum=$paging*10;			   //get the 10 most popular books starting from pageNum 0;		       $res = mysql_query(sprintf("SELECT * FROM Book order by popularity desc LIMIT $bookNum, 10"))or die(mysql_error());			   while ($row = mysql_fetch_assoc($res))			     	{			           if ($row['cover_path']==NULL)			           $b=array('type'=>0,'image'=>0);			           else			            {			              $b_id=$row['b_id'];				          $filename='../epubs/'.$b_id.'/'.$row['cover_path'];						  $path=pathinfo('../epubs/'.$b_id.'/'.$row['cover_path']);						  $filetype=$path['extension'];						  list($width, $height, $type, $attr) = getimagesize($filename);						  if ($height>201)						  {								 require_once("SimpleImage.php");								 $img = new SimpleImage();								 $img->load($filename);								 $img->resizeToHeight(200);								 $img->save($filename);						  }						  if ($filename) 						  {							 $imgbinary = fread(fopen($filename, "r"), filesize($filename));							 $base64 = chunk_split(base64_encode($imgbinary));                              $b=array('type'=>$filetype,'image'=>$base64);			                }			             }		                 header('Content-Type:application/json');			    	     $row=array_merge($b,$row);			    		 $array2[] = $row;			     	}			    	if (isset($array2))		            header('Content-Type:application/json');                    echo json_encode($array2);				 			}		}		break;    case 'POST':	        case 'PUT':       break;    case 'DELETE':}?>